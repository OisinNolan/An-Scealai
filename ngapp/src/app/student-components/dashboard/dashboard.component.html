<!-- Display the written story along with edit options -->
<div class="page">
  <div class="bookContainer">
    <div class="{{modalClass}} modalContainer">
      <div class="modalContent" *ngIf="story">
        <div class="modalText">{{ts.l.save_changes_made_to}} <b>{{story?.title}}</b>?</div>
        <div *ngIf="registrationError" class="errorMessage">{{errorText}}</div>
        <div>
          <button class="modalBtn" (click)="hideModal();">{{ts.l.cancel}}</button><button class="modalBtn createBtnGreen" (click)="saveModal()">{{ts.l.save}}</button>
        </div>
      </div>
    </div>
    <div class="bookHeader">
      <div class="headerUpper">

        <!-- BACK BUTTON TO LIST OF STUDENT'S STORIES -->
        <div routerLink="/contents" class="myStoriesBtn">
          <i class="fa fa-chevron-left backArrow"></i>
          {{ts.l.contents}}
        </div>

        <!-- SAVE ICON  -->
        <div class="saveIcon">
          <div *ngIf="storySaved" class="savedIcon">
            {{ts.l.saved}} <i class="fas fa-check"></i>
          </div>
          <div
            *ngIf="!storySaved"
            class="savedIcon"
            >
              {{ts.l.saving}}
              <i
                class="fas fa-save"
                >
              </i>
          </div>
        </div>
      </div>

      <!-- STORY TITLE -->
      <div class="storyTitle">
        <div>
          {{story?.title}}
          <span *ngIf="!storySaved">*</span>
        </div>

        <!-- CHANGE STORY DIALECT --
        <select *ngIf="dialects" [(ngModel)]="story.dialect" class="selectDialect">
          <option *ngFor="let d of dialects" [ngValue]="d.code">
          {{d.name}}
          </option>
        </select>
        -->

      </div>


      <div class="optionsBtnContainer" (click)="toggleOptions();">

        <div class="toggleShowOptions optionsBtn">
          <i *ngIf="!showOptions" class="fas fa-chevron-down"></i>
          <i *ngIf="showOptions" class="fas fa-chevron-right"></i>
        </div>

        <!-- EDIT STORY DETAILS -->
        <div *ngIf="showOptions" class="optionsBtn optionsPopupBtn" [routerLink]="['/story-details', story._id]">
          {{ts.l.edit_title_or_dialect}}
          <i class="fas fa-pencil-alt optionsBtnIcon"></i>
        </div>

        <!-- DOWNLOAD -->
        <div 
            *ngIf="showOptions"
            style="display: flex;"
            (click)="dontToggle=true">
          <a 
            style="text-decoration: none;"
            class="optionsBtn optionsPopupBtn"
            target="_blank"
            href="{{downloadStoryUrl()}}">
            Download
            <i class="fas fa-download optionsBtnIcon"></i>
          </a>
          <select 
               #downloadFormatOption
               style="border-end-end-radius: 0; background: rgba(0,0,0,0);"
               [(ngModel)]="downloadStoryFormat">
            <option>.pdf</option>
            <option>.docx</option>
            <option>.odt</option>
            <option>.pptx</option>
            <option>.md</option>
            <option>.txt</option>
            <option>.html</option>
            <option>.json</option>
            <!--
              <option>epub</option>
              <option>gfm</option>
            -->
            <option>.latex</option>
          </select>
        </div>
        <!-- FEEDBACK -->
        <div *ngIf="showOptions" class="optionsBtn optionsPopupBtn"
                                 (click)="this.dontToggle=true; defaultMode(); getFeedback()">
          {{ts.l.feedback}}
          <i class="fas fa-comment-dots optionsBtnIcon"></i>
          <span class="notificationBtn" *ngIf="hasNewFeedback()">1</span>
        </div>

        <!-- DICTIONARY -->
        <div *ngIf="showOptions" class="optionsBtn optionsPopupBtn"
                                 (click)="this.dontToggle=true; defaultMode(); showDictionary();">
          {{ts.l.dictionary}}
          <i class="fas fa-book optionsBtnIcon"></i>
        </div>

        <!-- AUDIO CHECK -->
        <div *ngIf="showOptions" class="optionsBtn optionsPopupBtn"
          (click)="this.dontToggle=true; goToSynthesis()">
          {{ts.l.audio_check}}
          <i class="fas fa-volume-up optionsBtnIcon"></i>
        </div>

        <!-- INLINE GRAMMAR CHECK -->
        <div *ngIf="showOptions" class="optionsBtn optionsPopupBtn"
          (click)="this.dontToggle=true;">
          <span
            *ngIf="grammarTagsHidden; else HideGrammarTags"
            (click)="showGrammarTags();">
              {{  ts.l.show_grammar_suggestions ?
                  ts.l.show_grammar_suggestions :
                  'show_grammar_suggestions' }}
            <i class="fas fa-spell-check optionsBtnIcon"></i>
          </span>
          <ng-template #HideGrammarTags>
            <span (click)="hideGrammarTags();">
              {{  ts.l.hide_grammar_suggestions ?
                  ts.l.hide_grammar_suggestions :
                  'hide_grammar_suggestions' }}
              <i class="fas fa-spell-check optionsBtnIcon"></i>
            </span>
            <div
              class="loader"
              *ngIf="grammarLoading">
            </div>
          </ng-template>
        </div>

        <!-- POPOUT GRAMMAR CHECK -->
        <!--
        <div *ngIf="showOptions"
             class="optionsBtn optionsPopupBtn"
             (click)="handleGrammarCheckerOptionClick();">
          {{ts.l.grammar_check}}
          <i class="fas fa-spell-check optionsBtnIcon"></i>
        </div>
        -->

        <!-- RECORDINGS -->
        <div *ngIf="showOptions" class="optionsBtn optionsPopupBtn"
          (click)="this.dontToggle=true; goToRecording()">
          {{ts.l.recordings}}
          <i class="fas fa-microphone optionsBtnIcon"></i>
        </div>

      </div>
    </div>

    <div class="selectErrorCheckbox">
      <div *ngFor="let recipient of (currentGrammarErrorTypes | keyvalue)" style="margin:2px;">
        <input
            [(ngModel)]="grammarTagFilter[recipient.key]"
            (ngModelChange)="grammarCheckBoxEvent(recipient.key, $event)"
            type="checkbox">
          {{recipient.key | lowercase}} ({{recipient.value}})
      </div> 
      <div style="margin: 2px;">
        <input 
          [(ngModel)]="quillHighlightService.showLeathanCaol"
          (ngModelChange)="leathanCaolCheckBox($event)"
          type="checkbox">
          leathan/caol
      </div>
      <button
        (click)="setAllCheckBoxes(false)">
        {{ ts.l.uncheck_all ? ts.l.uncheck_all : 'uncheck_all'}}
      </button>
      <button
        (click)="setAllCheckBoxes(true)">
        {{ ts.l.check_all ? ts.l.check_all : 'check_all'}}
      </button>
    </div>

    <!-- story contents -->
    <div class="storyContainer" *ngIf="story">
      <!-- display story before grammar checked (i.e. writing mode)-->
      <div class="textFieldContainer"  *ngIf="!feedbackVisible && !dictionaryVisible">
        <!--<textarea mwlTextInputElement class="textField" [(ngModel)]="story.text" (input)="storyEdited()" spellcheck="false"></textarea>-->
        
        <quill-editor
          [modules]="quillToolbar"
          placeholder=""
          [preserveWhitespace]="true"
          [(ngModel)]="story.htmlText" 
          (onContentChanged)="
              storyEdited($event);"
          (onEditorCreated)="quillEditor = $event"
        >
        </quill-editor>
         
      </div>

      <!-- display story with feedback excluding audio feedback-->
      <div class="textFieldContainer" *ngIf="feedbackVisible && !story.feedback.audioId">
        <div class="feedbackHeader"><div>{{ts.l.feedback}}</div> <div class="closeFeedbackBtn" (click)="closeFeedback()"><i class="fa fa-times"></i></div></div>
        <textarea
            class="textField feedbackTextarea"
            placeholder="{{ts.l.no_feedback_provided}}" 
            readonly
            value="{{story?.feedback.text}}">
        </textarea>

        <!--<textarea class="textField feedbackVisibleTextfield" value="{{story?.text}}" [(ngModel)]="story.text" (input)="storyEdited()"></textarea>-->
        <quill-editor
            [modules]="quillToolbar"
            placeholder=""
            [preserveWhitespace]="true"
            [(ngModel)]="story.htmlText"
            (onContentChanged)="
                storyEdited($event);">
        </quill-editor>
        
      </div>
      <!-- display story with feedback including audio feedback -->
      <div class="textFieldContainer" *ngIf="feedbackVisible && story.feedback.audioId">
        <div class="feedbackHeader"><div>{{ts.l.feedback}}</div> <div class="closeFeedbackBtn" (click)="closeFeedback()"><i class="fa fa-times"></i></div></div>
        <textarea class="textField feedbackTextareaAudio" placeholder="{{ts.l.no_feedback_provided}}" readonly value="{{story?.feedback.text}}"></textarea>
        <audio *ngIf="audioSource" [src]="audioSource" id="audio" controls #audioTag class="audioPlayer"></audio>
        <!--<textarea class="textField feedbackVisibleTextfieldAudio" value="{{story?.text}}" [(ngModel)]="story.text" (input)="storyEdited()"></textarea>-->
        
        <quill-editor
            [modules]="quillToolbar"
            placeholder=""
            [preserveWhitespace]="true"
            [(ngModel)]="story.htmlText"
            (onContentChanged)="
              storyEdited($event);">
        </quill-editor>
      </div>

      <!-- display dictionary option-->
      <div class="dictionaryModeContainer" *ngIf="dictionaryVisible && !feedbackVisible">
        <!--<textarea class="textField dictionaryVisibleTextField" value="{{story?.text}}" [(ngModel)]="story.text" (input)="storyEdited()"></textarea>-->
        
        <quill-editor
            class="quill-editor-dict"
            [modules]="quillToolbar"
            placeholder=""
            [preserveWhitespace]="true"
            [(ngModel)]="story.htmlText"
            (onContentChanged)="
                storyEdited($event);">
        </quill-editor>
        
        <div class="dictionaryContainer">
          <div class="dictionaryHeader"><div>{{ts.l.dictionary}}</div> <div class="closeDictionaryBtn" (click)="dictionaryVisible = false;"><i class="fa fa-times"></i></div></div>
          <div class="dictionarySubHeader">
            <div class="dictionaryName"
                 (click)="selectTeanglann = true;
                          selectExternalLinks = false; 
                          selectedDictionary = true;">
              Teanglann
            </div> |
            <div class="dictionaryName"
                 (click)="selectExternalLinks = true; 
                          selectTeanglann = false;">
              {{ts.l.external_links}}
            </div>
          </div>
          <iframe *ngIf="selectTeanglann" class="dictionaryIframe" src="https://www.teanglann.ie/en"></iframe>
          <div *ngIf="selectExternalLinks" class="dictionaryIframe" style="text-align: left;">
            <ul>
              <li><a href="http://www.potafocal.com/beo/" target="_blank">potafocal.com</a></li>
              <li><a href="https://www.focloir.ie" target="_blank">focloir.ie</a></li>
            </ul>
          </div>
          <!--
          <iframe *ngIf="selectPotafocal" class="dictionaryIframe" src="//www.focloir.ie"></iframe>
          -->
        </div>
      </div>
      
      <!-- Word Count -->
      <div style="display: flex; align-items: center; padding-bottom: 6px; padding-left: 8px; padding-top: 0; margin-top: 0;">
        <span> {{ts.l.word_count}}: {{wordCount}} </span>
      </div>
      <div>
        {{ quillHighlightService.mostRecentHoveredMessages ?
            quillHighlightService.mostRecentHoveredMessages[ts.l.iso_code] :
            'hover_over_a_highlighted_word_for_a_grammar_suggestion'}}
      </div>
      
      <!--
      <app-grammar-checker
          #grammarChecker
          *ngIf="story.text !== undefined"
          [classroomId]="classroomId"
          [story]="story"
          >
      </app-grammar-checker>
      -->

    </div>
    <!-- <app-chatbot></app-chatbot> -->
  </div>
</div>
