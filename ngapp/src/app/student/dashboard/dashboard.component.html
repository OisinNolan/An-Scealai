<!-- HEADER -->
<div class="storyTitleHeader" *ngIf="story">
  <!-- STORY TITLE -->
  <div class="storyTitleContainer">
    <input
      class="storyTitle"
      [ngStyle]="titleStyle()"
      size="{{ updatedTitle.length }}"
      [(ngModel)]="updatedTitle"
      (blur)="updateStoryTitle()"
    />
    <span *ngIf="!storySaved">*</span>
    <span style="color: rgba(0, 0, 0, 0.4)" *ngIf="story?.createdWithPrompts">
      {{ ts.l.made_using_prompts }}
    </span>
  </div>

  <!-- SAVE ICON  -->
  <div class="saveIcon">
    <div *ngIf="storySaved" class="savedIcon">
      {{ ts.l.saved }} <i class="fas fa-check"></i>
    </div>
    <div *ngIf="!storySaved" class="savedIcon">
      {{ ts.l.saving }}
      <i class="fas fa-save"> </i>
    </div>
  </div>
</div>

<!-- STORY OPTIONS TOOL BAR -->
<div class="optionsBtnContainer" (click)="toggleOptions()" *ngIf="story">
  <div class="optionsBtn">
    <i *ngIf="!showOptions" class="fas fa-chevron-down"></i>
    <i *ngIf="showOptions" class="fas fa-chevron-right"></i>
  </div>

  <!-- SPEECH TO TEXT-->
  <div
    *ngIf="showOptions"
    class="optionsBtn optionsPopupBtn"
    (click)="dontToggle = true; speakStory()"
    [ngClass]="{ disableDiv: isTranscribing }"
  >
    {{ ts.l.speak }}
    <!-- Google icon, index.html-->
    <span *ngIf="!isRecording" class="material-symbols-outlined optionsBtnIcon" >speech_to_text</span >
    <button *ngIf="isRecording && !isTranscribing" class="notRecordingBtn blink" >
      <i class="fas fa-stop-circle"></i>
    </button>
    <!-- transcribing speech/loading animation -->
    <div *ngIf="isTranscribing"><div class="dot-flashing"></div></div>
  </div>

  <!-- DOWNLOAD -->
  <div *ngIf="showOptions" style="display: flex" (click)="dontToggle = true">
    <button
      (click)="downloadStory()"
      style="text-decoration: none"
      class="optionsBtn optionsPopupBtn"
      target="_blank"
      href="{{ downloadStoryUrl() }}"
    >
      {{ ts.l.download }}
      <i class="fas fa-download optionsBtnIcon"></i>
    </button>
  </div>

  <!-- RECORDINGS -->
  <div
    *ngIf="showOptions"
    class="optionsBtn optionsPopupBtn"
    (click)="dontToggle = true; goToRecording()"
  >
    {{ ts.l.recordings }}
    <i class="fas fa-microphone optionsBtnIcon"></i>
  </div>

  <!-- FEEDBACK -->
  <div
    *ngIf="showOptions && hasFeedback"
    class="optionsBtn optionsPopupBtn"
    [class.optionsBtnClicked]="rightDrawerOpened && selectedDrawer == 'feedback'"
    (click)="dontToggle = true; toggleRightDrawer('feedback')"
  >
    {{ ts.l.feedback }}
    <i class="fas fa-comment-dots optionsBtnIcon"></i>
    <!-- <span class="notificationBtn" *ngIf="hasFeedback">1</span> -->
  </div>

  <!-- SYNTHESIS -->
  <div
    *ngIf="showOptions"
    class="optionsBtn optionsPopupBtn"
    (click)="dontToggle = true; synthesisPlayer.toggleHidden()"
  >
    {{ ts.l.audio_check }}
    <i class="fas fa-volume-up optionsBtnIcon"></i>
  </div>

  <!-- GRAMMAR CHECK -->
  <div
    *ngIf="showOptions"
    class="optionsBtn optionsPopupBtn"
    [class.optionsBtnClicked]="rightDrawerOpened && selectedDrawer == 'grammar'"
    (click)="dontToggle = true; toggleRightDrawer('grammar')"
  >
    {{ ts.l.grammar_errors }}
    <i class="fas fa-spell-check optionsBtnIcon"></i>
  </div>

  <!-- DICTIONARY -->
  <div
    *ngIf="showOptions"
    class="optionsBtn optionsPopupBtn"
    [class.optionsBtnClicked]="rightDrawerOpened && selectedDrawer == 'dictionary'"
    (click)="dontToggle = true; toggleRightDrawer('dictionary')"
  >
    {{ ts.l.dictionary }}
    <i class="fas fa-book optionsBtnIcon"></i>
  </div>
</div>

<!-- BODY CONTAINER-->
<mat-drawer-container class="bodyContainer" autosize>
  <!-- STORY LIST DRAWER-->
  <mat-drawer #storyDrawer class="storyListDrawer" mode="side" opened="true">
    <app-story-drawer
      #storyDrawer
      (storyEmitter)="setCurrentStory($event)"
      (hasFeedback)="hasFeedback = $event"
    ></app-story-drawer>
  </mat-drawer>

  <!-- STORY WRITING CONTAINER-->
  <div class="storyContainer">
    <div class="ql-container" #quillHeightSpan [ngStyle]="quillEditorStyle" *ngIf="story; else newStoryMessage" >
      <!-- STORY DRAWER BUTTON-->
      <mat-icon class="menuButton" (click)="storyDrawer.toggle()" >menu</mat-icon >
      <!-- QUILL EDITOR AND TOOLBAR-->
      <quill-editor
        [modules]="quillToolbar"
        placeholder=""
        [preserveWhitespace]="true"
        [debounceTime]="1500"
        [(ngModel)]="story.htmlText"
        (onContentChanged)="onContentChanged($event)"
        (onEditorCreated)="onEditorCreated($event)"
      ></quill-editor>
    </div>

    <!-- NO STORIES MESSAGE-->
    <ng-template #newStoryMessage>
      <div class="newStoryMessage">
        Click on the '+' button to create your first story!
      </div>
    </ng-template>
  </div>

  <mat-drawer #rightDrawer class="rightDrawer" mode="side" position="end">
    <!-- FEEDBACK -->
    <app-feedback-drawer
      *ngIf="selectedDrawer == 'feedback'"
      [story]="story"
      (closeFeedbackEmitter)="toggleRightDrawer('feedback')"
    ></app-feedback-drawer>
    <!-- DICTIONARY -->
    <app-dictionary-drawer
      *ngIf="selectedDrawer == 'dictionary'"
      (closeDictionaryEmitter)="toggleRightDrawer('dictionary')"
    ></app-dictionary-drawer>
    <!-- GRAMMAR CHECKER -->
    <app-grammar-error-drawer
      *ngIf="selectedDrawer == 'grammar'"
      [quillHighlighter]="quillHighlighter"
      [grammarLoaded]="grammarLoaded"
      [grammarErrorsTypeDict]="grammarErrorsTypeDict"
      [checkBoxes]="checkBoxes"
      (closeGrammarEmitter)="toggleRightDrawer('grammar')"
    ></app-grammar-error-drawer>
  </mat-drawer>
</mat-drawer-container>

<app-synthesis-player
  #mySynthesisPlayer
  [text]="story?.text"
  [storyId]="story?._id"
  [storyTitle]="story?.title"
>
</app-synthesis-player>
